#' @export
print.fmode <- function(x, ...) {
  print(format(x, ...), quote = FALSE)

  invisible(x)
}

#' @export
format.fmode <- function(x, ...) {
  vapply(x, strmode_, character(1))
}

#' @export
as.character.fmode <- format.fmode

#' @export
`[.fmode` <- function(x, i) {
  cl <- oldClass(x)
  y <- NextMethod("[")
  oldClass(y) <- cl
  y
}

#' @rdname fmode
#' @export
as_fmode <- function(x) {
  UseMethod("as_fmode")
}

#' @export
as_fmode.fmode <- identity

#' @export
as_fmode.character <- function(x) {
  structure(getmode_(x), class = "fmode")
}

#' @export
as_fmode.octmode <- function(x) {
  class(x) <- "fmode"
  x
}

#' @export
as_fmode.numeric <- function(x) {
  if (all(is.na(x) | x == as.integer(x))) {
    x <- as.integer(x)
    return(structure(x, class = "fmode"))
  }
  stop("'x' cannot be coerced to class \"fmode\"", call. = FALSE)
}

#' @export
as_fmode.integer <- function(x) {
  return(structure(x, class = "fmode"))
}

#' File permissions
#' @param x An object which is to be coerced to a fmode object. Can be an
#'   number or hexidecimal character representation, including symbolic
#'   representations.
#' @export
fmode <- as_fmode

#' @export
`!.fmode` <- function(a) {
  as_fmode(bitwNot(as_fmode(a)))
}

#' @export
`&.fmode` <- function(a, b) {
  as_fmode(bitwAnd(as_fmode(a), as_fmode(b)))
}

#' @export
`|.fmode` <- function(a, b) {
  as_fmode(bitwOr(as_fmode(a), as_fmode(b)))
}

#' @export
`==.fmode` <- function(a, b) {
  b <- as_fmode(b)
  unclass(a & b) == unclass(b)
}
